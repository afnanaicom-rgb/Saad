<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Studio Ultimate - Image Editor</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@300;400;500;700;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Noto Sans Arabic', sans-serif;
            background-color: #000000;
            color: #e5e5e5;
            overflow: hidden;
        }

        .font-code { font-family: 'JetBrains Mono', monospace; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Glassmorphism Logic */
        .glass-header {
            background: rgba(10, 10, 10, 0.6);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .glass-input-container {
            background: rgba(30, 30, 30, 0.6);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }

        .glass-pro-card {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(0, 0, 0, 0.4));
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 215, 0, 0.2);
        }

        /* Sidebar & Popover Animations */
        #sidebar { transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1); box-shadow: -10px 0 40px rgba(0,0,0,0.8); }
        .popover-menu {
            background-color: #1a1a1a;
            border: 1px solid #333;
            box-shadow: 0 10px 40px rgba(0,0,0,0.8);
            animation: popUp 0.2s cubic-bezier(0.16, 1, 0.3, 1);
            transform-origin: bottom right;
        }

        /* Chat Bubbles */
        .chat-bubble-user {
            background: #262626; color: #fff; border-radius: 18px 4px 18px 18px; padding: 12px 16px;
            max-width: 85%; align-self: flex-start; border: 1px solid rgba(255,255,255,0.1); user-select: text;
        }
        .chat-bubble-ai {
            background: transparent; color: #e5e5e5; border-radius: 4px 18px 18px 18px; padding: 12px 0px;
            max-width: 95%; align-self: flex-end; user-select: text; width: 100%;
        }

        .pro-badge {
            background: linear-gradient(90deg, #FFD700, #FFA500); color: black; font-weight: 800; font-size: 0.6rem;
            padding: 2px 6px; border-radius: 4px;
        }

        @keyframes popUp { from { opacity: 0; transform: scale(0.9) translateY(10px); } to { opacity: 1; transform: scale(1) translateY(0); } }
        .animate-msg { animation: fadeInUp 0.3s ease-out forwards; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Animation for Mode Icon Appearance */
        @keyframes scaleIn { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .mode-icon-enter { animation: scaleIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }

        /* --- Image Editor Styles --- */
        #imageEditorModal { transition: opacity 0.3s ease; }
        .canvas-container { position: relative; display: inline-block; overflow: hidden; border-radius: 12px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .tool-btn-active { background: rgba(255,255,255,0.2); border-color: rgba(255,255,255,0.4); color: white; box-shadow: 0 0 15px rgba(255,255,255,0.1); }
        
        /* Rainbow Glow Animation Logic is handled in JS via Canvas Shadow */
    </style>
</head>
<body class="flex flex-col h-screen relative">

    <div id="overlay" onclick="closeAll()" class="hidden fixed inset-0 z-40 bg-black/60 backdrop-blur-sm transition-opacity duration-300"></div>

    <aside id="sidebar" class="fixed top-0 right-0 h-full w-[260px] bg-[#0a0a0a] z-50 flex flex-col border-l border-white/5 transform translate-x-full">
        <div class="p-5 flex justify-between items-center">
            <h2 class="font-bold text-xl text-white tracking-wide">المكتبة</h2>
            <button onclick="toggleSidebar()" class="w-8 h-8 rounded-full hover:bg-white/10 flex items-center justify-center transition"><i class="fa-solid fa-xmark text-gray-400"></i></button>
        </div>

        <div class="px-4 mb-4">
            <div class="glass-pro-card rounded-xl p-4 relative overflow-hidden group cursor-pointer hover:brightness-110 transition">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-white font-bold text-sm flex items-center gap-2"><i class="fa-solid fa-crown text-yellow-400"></i> عضوية PRO</span>
                </div>
                <p class="text-[10px] text-gray-400 leading-relaxed">فتح كافة المميزات المتقدمة.</p>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto px-4 pb-4 hide-scrollbar space-y-3">
            <div class="text-[10px] font-bold text-gray-600 px-1 uppercase tracking-wider">السجل</div>
            <div class="flex gap-3 p-2 rounded-lg hover:bg-white/5 cursor-pointer transition border border-transparent hover:border-white/5">
                <div class="w-10 h-10 rounded bg-gray-800 flex items-center justify-center text-gray-500"><i class="fa-regular fa-image"></i></div>
                <div class="flex flex-col justify-center"><p class="text-xs font-bold text-gray-300 truncate w-32">مشروع نيوم</p><span class="text-[9px] text-gray-600">منذ ساعة</span></div>
            </div>
        </div>
    </aside>

    <header class="glass-header absolute top-0 left-0 right-0 z-30 flex justify-between items-center px-4 py-3">
        <button class="w-10 h-10 flex items-center justify-center rounded-full bg-white/5 hover:bg-white/10 transition backdrop-blur-md">
            <i class="fa-solid fa-arrow-right text-gray-300 text-sm"></i> 
        </button>

        <div class="flex bg-black/40 backdrop-blur-md border border-white/10 rounded-full p-1 shadow-inner relative">
            <div id="tabIndicator" class="absolute top-1 bottom-1 w-[calc(50%-4px)] bg-white/10 rounded-full transition-all duration-300 border border-white/5 right-1"></div>
            <button onclick="switchTab('imagine')" class="relative z-10 w-20 py-1.5 rounded-full text-xs font-bold text-white transition text-center">تخيل</button>
            <button onclick="switchTab('chat')" class="relative z-10 w-20 py-1.5 rounded-full text-xs font-bold text-gray-400 hover:text-white transition text-center">محادثة</button>
        </div>

        <button onclick="toggleSidebar()" class="w-10 h-10 flex items-center justify-center rounded-full hover:bg-white/10 transition"><i class="fa-solid fa-bars text-gray-300"></i></button>
    </header>

    <main class="flex-1 w-full h-full relative overflow-hidden bg-black">
        <div id="view-imagine" class="absolute inset-0 overflow-y-auto hide-scrollbar pt-24 pb-40 transition-opacity duration-300 opacity-100 z-10">
            <div class="columns-2 md:columns-3 lg:columns-4 gap-3 space-y-3 px-3">
                <div class="break-inside-avoid rounded-2xl overflow-hidden relative group cursor-pointer" onclick="openImageEditor(this.querySelector('img').src)">
                    <img src="https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?w=600&q=80" class="w-full object-cover">
                </div>
                <div class="break-inside-avoid rounded-2xl overflow-hidden relative group cursor-pointer" onclick="openImageEditor(this.querySelector('img').src)">
                    <img src="https://images.unsplash.com/photo-1620641788421-7a1c342ea42e?w=600&q=80" class="w-full object-cover">
                </div>
                <div class="break-inside-avoid rounded-2xl overflow-hidden relative group cursor-pointer" onclick="openImageEditor(this.querySelector('img').src)">
                    <img src="https://i.postimg.cc/VkkF71gv/grok-image-x6em5fj-edit-96291120058942.png" class="w-full object-cover">
                </div>
            </div>
            <div class="h-10"></div>
        </div>

        <div id="view-chat" class="absolute inset-0 overflow-y-auto hide-scrollbar pt-24 pb-40 transition-opacity duration-300 opacity-0 pointer-events-none z-0 px-4">
            <div id="chatContainer" class="flex flex-col gap-6 max-w-3xl mx-auto">
                <div class="flex gap-4 items-start animate-msg">
                    <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-indigo-500 to-purple-600 flex-shrink-0 flex items-center justify-center"><i class="fa-solid fa-sparkles text-white text-xs"></i></div>
                    <div class="chat-bubble-ai"><p class="text-sm leading-6">مرحباً! اختر وضعاً من الأدوات أو ابدأ الكتابة مباشرة. يمكنك الضغط على أي صورة للتعديل عليها.</p></div>
                </div>
                <div class="flex gap-4 items-start animate-msg">
                    <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-indigo-500 to-purple-600 flex-shrink-0 flex items-center justify-center"><i class="fa-solid fa-sparkles text-white text-xs"></i></div>
                    <div class="chat-bubble-ai p-2">
                        <p class="mb-2 text-xs text-gray-400 px-2">مثال على صورة (اضغط للتعديل):</p>
                        <img src="https://i.postimg.cc/VkkF71gv/grok-image-x6em5fj-edit-96291120058942.png" onclick="openImageEditor(this.src)" class="rounded-xl max-w-xs cursor-pointer border border-white/10 hover:brightness-110 transition">
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="imageEditorModal" class="hidden fixed inset-0 z-[100] bg-black/95 backdrop-blur-2xl flex flex-col items-center justify-center opacity-0">
        
        <div class="absolute top-4 left-4 right-4 flex justify-between items-center z-20">
            <button onclick="closeImageEditor()" class="w-10 h-10 rounded-full bg-black/40 text-white hover:bg-white/10 border border-white/10 flex items-center justify-center transition">
                <i class="fa-solid fa-xmark"></i>
            </button>
            <div class="bg-black/40 px-4 py-1 rounded-full border border-white/10 text-xs font-bold text-gray-300">
                وضع التعديل
            </div>
            <button onclick="clearCanvas()" class="w-10 h-10 rounded-full bg-black/40 text-gray-400 hover:text-white hover:bg-white/10 border border-white/10 flex items-center justify-center transition" title="مسح التحديد">
                <i class="fa-solid fa-rotate-left"></i>
            </button>
        </div>

        <div class="relative flex-1 w-full flex items-center justify-center p-4" id="editorContainer">
            <div class="canvas-container relative" id="canvasWrapper">
                <img id="editorImage" src="" class="max-h-[70vh] max-w-full object-contain pointer-events-none select-none">
                <canvas id="drawingCanvas" class="absolute inset-0 cursor-crosshair touch-none"></canvas>
            </div>
        </div>

        <div class="absolute bottom-6 left-0 right-0 px-4 w-full max-w-3xl mx-auto z-20 flex flex-col gap-3">
            
            <div class="flex items-center justify-center gap-4 mb-2">
                <button onclick="setTool('eraser')" id="btn-eraser" class="w-12 h-12 rounded-full glass-input-container flex items-center justify-center text-gray-400 hover:text-white transition group relative">
                    <i class="fa-solid fa-eraser text-lg"></i>
                    <span class="absolute -top-8 text-[10px] bg-black px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition">حذف</span>
                </button>
                
                <button onclick="setTool('magic')" id="btn-magic" class="w-14 h-14 rounded-full glass-input-container flex items-center justify-center text-gray-400 hover:text-white transition group relative border-2 border-transparent">
                    <i class="fa-solid fa-wand-magic-sparkles text-xl"></i>
                    <span class="absolute -top-8 text-[10px] bg-black px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition whitespace-nowrap">تعديل (طيف)</span>
                </button>
                
                <button onclick="setTool('draw')" id="btn-draw" class="w-12 h-12 rounded-full glass-input-container flex items-center justify-center text-gray-400 hover:text-white transition group relative">
                    <i class="fa-solid fa-paintbrush text-lg"></i>
                    <span class="absolute -top-8 text-[10px] bg-black px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition">رسم</span>
                </button>
            </div>

            <div class="glass-input-container rounded-[24px] p-1.5 flex items-center gap-2">
                <div class="w-10 h-10 rounded-full flex items-center justify-center bg-white/5 border border-white/5">
                    <i class="fa-solid fa-pen-to-square text-gray-400 text-sm"></i>
                </div>
                <input type="text" id="editPrompt" class="flex-1 bg-transparent text-white text-sm px-2 outline-none text-right placeholder-gray-500" placeholder="صف التعديل المطلوب هنا...">
                <button onclick="submitEdit()" class="w-10 h-10 rounded-full bg-blue-600 hover:bg-blue-500 text-white flex items-center justify-center transition shadow-lg">
                    <i class="fa-solid fa-paper-plane text-xs"></i>
                </button>
            </div>
        </div>

    </div>
    <div class="fixed bottom-0 left-0 right-0 p-4 pb-6 bg-gradient-to-t from-black via-[#050505] to-transparent z-40">
        
        <div id="toolsMenu" class="hidden absolute bottom-[95px] right-4 w-[240px] popover-menu rounded-2xl p-2 flex flex-col gap-1 z-50">
            <div class="px-3 py-2 text-[10px] font-bold text-gray-500 uppercase tracking-wider border-b border-white/5 mb-1">الأوضاع</div>
            
            <button onclick="activateMode('image', 'fa-image', 'text-blue-400')" class="flex items-center justify-between p-2.5 rounded-lg hover:bg-white/10 transition group">
                <div class="flex items-center gap-3"><i class="fa-solid fa-image text-blue-400 w-5 text-center"></i><span class="text-xs font-bold text-gray-200">توليد صور</span></div>
            </button>

            <button onclick="activateMode('video', 'fa-video', 'text-yellow-400')" class="flex items-center justify-between p-2.5 rounded-lg hover:bg-white/10 transition group border border-yellow-500/10 bg-yellow-500/5">
                <div class="flex items-center gap-3"><i class="fa-solid fa-video text-yellow-400 w-5 text-center"></i><span class="text-xs font-bold text-gray-200">فيديو سينمائي</span></div>
                <span class="pro-badge text-[8px]">PRO</span>
            </button>

            <button onclick="activateMode('agent', 'fa-robot', 'text-emerald-400')" class="flex items-center justify-between p-2.5 rounded-lg hover:bg-white/10 transition group">
                <div class="flex items-center gap-3"><i class="fa-solid fa-robot text-emerald-400 w-5 text-center"></i><span class="text-xs font-bold text-gray-200">وكيل ذكي (Agent)</span></div>
            </button>

            <button onclick="activateMode('code', 'fa-code', 'text-orange-400')" class="flex items-center justify-between p-2.5 rounded-lg hover:bg-white/10 transition group">
                <div class="flex items-center gap-3"><i class="fa-solid fa-code text-orange-400 w-5 text-center"></i><span class="text-xs font-bold text-gray-200 font-code">Code Chat</span></div>
                <div class="text-[8px] border border-white/10 px-1 rounded text-gray-500">EN</div>
            </button>
        </div>

        <div class="glass-input-container rounded-[32px] p-2 relative transition-all duration-300 max-w-3xl mx-auto">
            <div id="previewArea" class="hidden flex gap-2 mb-0 px-2 pt-2 pb-2 overflow-x-auto hide-scrollbar w-full border-b border-white/5"></div>

            <div class="flex items-end gap-2 p-1">
                
                <div class="flex items-center gap-2 mb-1 ml-1" id="leftControls">
                    
                    <button id="toolsBtn" onclick="toggleTools()" class="w-10 h-10 rounded-full flex items-center justify-center bg-white/5 hover:bg-white/15 text-gray-300 transition active:scale-95 border border-white/5">
                        <i class="fa-solid fa-sliders text-sm"></i>
                    </button>

                    <div id="modeChip" class="hidden w-10 h-10 rounded-full items-center justify-center relative group cursor-pointer mode-icon-enter bg-white/5 border border-white/10" onclick="resetMode()">
                        <i id="chipIcon" class="text-sm"></i>
                        <div class="absolute inset-0 bg-black/60 rounded-full hidden group-hover:flex items-center justify-center transition backdrop-blur-[2px]">
                            <i class="fa-solid fa-xmark text-white text-[10px]"></i>
                        </div>
                    </div>

                    <button onclick="document.getElementById('fileInput').click()" class="w-10 h-10 rounded-full flex items-center justify-center bg-white/5 hover:bg-white/15 text-gray-300 transition active:scale-95 border border-white/5">
                        <i class="fa-solid fa-plus text-sm"></i>
                    </button>
                    <input type="file" id="fileInput" class="hidden" multiple accept="image/*" onchange="handleUpload(this)">
                </div>

                <div class="flex-1 flex flex-col justify-center min-h-[44px]">
                    <textarea id="promptInput" rows="1" class="w-full bg-transparent text-white placeholder-gray-500 text-right px-2 py-2.5 outline-none resize-none text-sm leading-relaxed" placeholder="اكتب ما تريد..." oninput="handleInput(this)"></textarea>
                </div>

                <div class="flex-shrink-0 w-11 h-11 mb-0.5 relative">
                    <button id="magicBtn" class="absolute inset-0 rounded-full bg-gradient-to-tr from-indigo-600 to-violet-600 flex items-center justify-center shadow-lg hover:scale-105 transition-all duration-300 z-10 border border-white/10">
                        <i class="fa-solid fa-wand-magic-sparkles text-white text-sm"></i>
                    </button>
                    <button id="sendBtn" onclick="sendMessage()" class="absolute inset-0 rounded-full bg-white flex items-center justify-center shadow-lg transform scale-50 opacity-0 transition-all duration-300 z-20 hover:bg-gray-200">
                        <i class="fa-solid fa-arrow-up text-black text-sm"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Core Application Logic ---
        let currentMode = 'chat';
        let selectedTool = null;
        let uploadedFiles = [];

        function switchTab(tab) {
            const ind = document.getElementById('tabIndicator');
            const viewImg = document.getElementById('view-imagine');
            const viewChat = document.getElementById('view-chat');
            if (tab === 'chat') {
                ind.style.right = 'auto'; ind.style.left = '4px';
                viewImg.classList.replace('opacity-100', 'opacity-0'); viewImg.classList.add('pointer-events-none', 'z-0');
                viewChat.classList.replace('opacity-0', 'opacity-100'); viewChat.classList.remove('pointer-events-none', 'z-0');
                currentMode = 'chat';
            } else {
                ind.style.left = 'auto'; ind.style.right = '4px';
                viewChat.classList.replace('opacity-100', 'opacity-0'); viewChat.classList.add('pointer-events-none', 'z-0');
                viewImg.classList.replace('opacity-0', 'opacity-100'); viewImg.classList.remove('pointer-events-none', 'z-0');
                currentMode = 'imagine';
            }
        }

        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('translate-x-full'); document.getElementById('overlay').classList.toggle('hidden'); }
        function toggleTools() { document.getElementById('toolsMenu').classList.toggle('hidden'); document.getElementById('overlay').classList.toggle('hidden'); }
        function closeAll() {
            document.getElementById('sidebar').classList.add('translate-x-full');
            document.getElementById('toolsMenu').classList.add('hidden');
            document.getElementById('overlay').classList.add('hidden');
        }

        function activateMode(id, icon, colorClass) {
            selectedTool = id;
            document.getElementById('toolsMenu').classList.add('hidden');
            document.getElementById('overlay').classList.add('hidden');
            const chip = document.getElementById('modeChip');
            chip.classList.remove('hidden'); chip.classList.add('flex');
            const iElement = document.getElementById('chipIcon');
            iElement.className = `fa-solid ${icon} ${colorClass.replace('text-', 'text-')}`;
            if (id === 'video') { chip.style.borderColor = "rgba(250, 204, 21, 0.4)"; chip.style.background = "rgba(250, 204, 21, 0.1)"; }
            else if (id === 'agent') { chip.style.borderColor = "rgba(52, 211, 153, 0.4)"; chip.style.background = "rgba(52, 211, 153, 0.1)"; }
            else if (id === 'code') { chip.style.borderColor = "rgba(251, 146, 60, 0.4)"; chip.style.background = "rgba(251, 146, 60, 0.1)"; }
            else { chip.style.borderColor = "rgba(255, 255, 255, 0.2)"; chip.style.background = "rgba(255, 255, 255, 0.05)"; }
        }

        function resetMode() { selectedTool = null; document.getElementById('modeChip').classList.add('hidden'); document.getElementById('modeChip').classList.remove('flex'); }

        function sendMessage() {
            const input = document.getElementById('promptInput');
            const text = input.value.trim();
            const previewArea = document.getElementById('previewArea');
            
            if (!text && uploadedFiles.length === 0) return;
            if (currentMode !== 'chat') switchTab('chat');

            const container = document.getElementById('chatContainer');
            const userDiv = document.createElement('div');
            userDiv.className = 'flex flex-col gap-2 self-start w-full animate-msg';
            
            let imagesHtml = '';
            if (uploadedFiles.length > 0) {
                // Modified: Added onclick to open editor for uploaded images
                imagesHtml = `<div class="flex gap-2 overflow-x-auto hide-scrollbar mb-1">${uploadedFiles.map(file => {
                    const src = URL.createObjectURL(file);
                    return `<img src="${src}" onclick="openImageEditor('${src}')" class="w-32 h-32 object-cover rounded-lg border border-white/10 cursor-pointer hover:brightness-110 transition">`;
                }).join('')}</div>`;
            }

            userDiv.innerHTML = `
                <div class="flex gap-4 items-start flex-row-reverse">
                    <div class="w-8 h-8 rounded-full bg-white/10 flex-shrink-0 flex items-center justify-center"><i class="fa-solid fa-user text-gray-400 text-xs"></i></div>
                    <div class="chat-bubble-user text-right" dir="rtl">${imagesHtml}<p class="whitespace-pre-wrap">${text}</p></div>
                </div>`;
            container.appendChild(userDiv);

            input.value = ''; input.style.height = 'auto'; previewArea.innerHTML = ''; previewArea.classList.add('hidden'); uploadedFiles = []; handleInput(input);
            const viewChat = document.getElementById('view-chat');
            viewChat.scrollTo({ top: viewChat.scrollHeight, behavior: 'smooth' });

            simulateAIResponse(container, selectedTool);
        }

        function simulateAIResponse(container, mode) {
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'flex gap-4 items-start animate-msg mt-4';
            loadingDiv.innerHTML = `<div class="w-8 h-8 rounded-full bg-gradient-to-tr from-indigo-500 to-purple-600 flex-shrink-0 flex items-center justify-center"><i class="fa-solid fa-circle-notch fa-spin text-white text-xs"></i></div>`;
            container.appendChild(loadingDiv);
            
            const viewChat = document.getElementById('view-chat');
            viewChat.scrollTo({ top: viewChat.scrollHeight, behavior: 'smooth' });

            setTimeout(() => {
                loadingDiv.remove();
                const aiDiv = document.createElement('div');
                aiDiv.className = 'flex gap-4 items-start animate-msg w-full';
                let content = "", dir = "rtl";
                
                // Response Logic
                if (mode === 'code') { dir = "ltr"; content = `<p class="mb-2 text-gray-300">Here is a Python example:</p><div class="bg-[#1e1e1e] p-3 rounded-lg border border-white/10 font-code text-xs text-blue-200 overflow-x-auto">print("Hello World")</div>`; } 
                else if (mode === 'agent') { content = `<p class="text-emerald-400 font-bold mb-1"><i class="fa-solid fa-robot ml-1"></i> تحليل الوكيل الذكي:</p><p>لقد قمت بتحليل طلبك، وهذه هي الخطوات المقترحة للتنفيذ...</p>`; } 
                else if (mode === 'video') { content = `<p class="mb-2">جارٍ التوليد السينمائي...</p><div class="w-full h-48 bg-black rounded-lg border border-white/10 flex items-center justify-center relative overflow-hidden group"><i class="fa-solid fa-film text-4xl text-white/50"></i></div>`; } 
                else { content = `<p>شكراً لرسالتك. اضغط على أي صورة لفتح المحرر.</p>`; }

                aiDiv.innerHTML = `<div class="w-8 h-8 rounded-full bg-gradient-to-tr from-indigo-500 to-purple-600 flex-shrink-0 flex items-center justify-center"><i class="fa-solid fa-sparkles text-white text-xs"></i></div><div class="chat-bubble-ai" dir="${dir}">${content}</div>`;
                container.appendChild(aiDiv);
                viewChat.scrollTo({ top: viewChat.scrollHeight, behavior: 'smooth' });
            }, 1000);
        }

        function handleInput(textarea) {
            textarea.style.height = 'auto'; textarea.style.height = textarea.scrollHeight + 'px';
            if (textarea.value.trim().length > 0 || uploadedFiles.length > 0) {
                document.getElementById('magicBtn').style.opacity = '0'; document.getElementById('magicBtn').style.transform = 'scale(0.5)';
                document.getElementById('sendBtn').style.opacity = '1'; document.getElementById('sendBtn').style.transform = 'scale(1)';
            } else {
                document.getElementById('magicBtn').style.opacity = '1'; document.getElementById('magicBtn').style.transform = 'scale(1)';
                document.getElementById('sendBtn').style.opacity = '0'; document.getElementById('sendBtn').style.transform = 'scale(0.5)';
            }
        }

        function handleUpload(input) {
            const files = Array.from(input.files);
            if(files.length > 0) document.getElementById('previewArea').classList.remove('hidden');
            files.forEach(file => {
                uploadedFiles.push(file);
                const div = document.createElement('div'); div.className = 'relative w-14 h-14 rounded overflow-hidden flex-shrink-0 border border-white/20';
                const img = document.createElement('img'); img.src = URL.createObjectURL(file); img.className = 'w-full h-full object-cover';
                div.appendChild(img); document.getElementById('previewArea').appendChild(div);
            });
            input.value = ''; handleInput(document.getElementById('promptInput'));
        }

        /* ================= IMAGE EDITOR LOGIC ================= */
        const modal = document.getElementById('imageEditorModal');
        const imgElement = document.getElementById('editorImage');
        const canvas = document.getElementById('drawingCanvas');
        const ctx = canvas.getContext('2d');
        
        let currentEditorTool = null; // 'eraser', 'magic', 'draw'
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;
        let hue = 0; // For rainbow effect

        function openImageEditor(src) {
            imgElement.src = src;
            modal.classList.remove('hidden');
            // Slight delay to allow transition
            setTimeout(() => { modal.classList.remove('opacity-0'); }, 10);
            
            // Setup canvas size to match image after it loads
            imgElement.onload = () => {
                resizeCanvas();
            };
            // Default tool
            setTool('magic'); 
        }

        function closeImageEditor() {
            modal.classList.add('opacity-0');
            setTimeout(() => {
                modal.classList.add('hidden');
                clearCanvas();
                currentEditorTool = null;
            }, 300);
        }

        function resizeCanvas() {
            canvas.width = imgElement.offsetWidth;
            canvas.height = imgElement.offsetHeight;
        }

        window.addEventListener('resize', resizeCanvas);

        function setTool(tool) {
            currentEditorTool = tool;
            
            // Reset UI
            ['eraser', 'magic', 'draw'].forEach(t => {
                const btn = document.getElementById(`btn-${t}`);
                if (t === tool) {
                    btn.classList.add('tool-btn-active');
                    if(t === 'magic') btn.style.borderColor = "#c084fc"; // Purple border for magic
                    else btn.style.borderColor = "rgba(255,255,255,0.4)";
                } else {
                    btn.classList.remove('tool-btn-active');
                    btn.style.borderColor = "transparent";
                }
            });
        }

        function clearCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        // --- Drawing Logic ---
        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseout', stopDrawing);
        
        // Touch support
        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent('mousedown', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            canvas.dispatchEvent(mouseEvent);
        });
        canvas.addEventListener('touchmove', (e) => {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent('mousemove', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            canvas.dispatchEvent(mouseEvent);
        });
        canvas.addEventListener('touchend', () => {
            const mouseEvent = new MouseEvent('mouseup', {});
            canvas.dispatchEvent(mouseEvent);
        });


        function startDrawing(e) {
            if (!currentEditorTool) return;
            isDrawing = true;
            [lastX, lastY] = getCoordinates(e);
        }

        function draw(e) {
            if (!isDrawing) return;
            const [x, y] = getCoordinates(e);
            
            ctx.lineJoin = 'round';
            ctx.lineCap = 'round';

            if (currentEditorTool === 'eraser') {
                ctx.globalCompositeOperation = 'destination-out';
                ctx.lineWidth = 20;
                ctx.shadowBlur = 0;
                ctx.strokeStyle = 'rgba(0,0,0,1)';
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(x, y);
                ctx.stroke();
                ctx.globalCompositeOperation = 'source-over'; // Reset
            } else if (currentEditorTool === 'draw') {
                ctx.lineWidth = 4;
                ctx.strokeStyle = '#ffffff';
                ctx.shadowBlur = 0;
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(x, y);
                ctx.stroke();
            } else if (currentEditorTool === 'magic') {
                // THE RAINBOW GLOW EFFECT
                ctx.lineWidth = 6;
                
                // Create Rainbow Gradient
                hue++;
                const color = `hsl(${hue}, 100%, 50%)`;
                
                ctx.strokeStyle = color;
                ctx.shadowBlur = 15; // Glow amount
                ctx.shadowColor = color; // Glow color matches line
                
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(x, y);
                ctx.stroke();
            }

            [lastX, lastY] = [x, y];
        }

        function stopDrawing() {
            isDrawing = false;
        }

        function getCoordinates(e) {
            const rect = canvas.getBoundingClientRect();
            return [e.clientX - rect.left, e.clientY - rect.top];
        }

        function submitEdit() {
            const prompt = document.getElementById('editPrompt').value;
            if(!prompt) return;
            
            closeImageEditor();
            
            // Simulate sending command to AI
            if (currentMode !== 'chat') switchTab('chat');
            const container = document.getElementById('chatContainer');
            
            // Add user message about edit
            const userDiv = document.createElement('div');
            userDiv.className = 'flex gap-4 items-start flex-row-reverse animate-msg';
            userDiv.innerHTML = `
                <div class="w-8 h-8 rounded-full bg-white/10 flex-shrink-0 flex items-center justify-center"><i class="fa-solid fa-user text-gray-400 text-xs"></i></div>
                <div class="chat-bubble-user text-right" dir="rtl">
                    <p class="text-xs text-yellow-500 font-bold mb-1"><i class="fa-solid fa-pen-nib ml-1"></i>طلب تعديل صورة</p>
                    <p>${prompt}</p>
                </div>`;
            container.appendChild(userDiv);
            document.getElementById('editPrompt').value = '';

            simulateAIResponse(container, 'edit');
        }

    </script>
</body>
</html>
